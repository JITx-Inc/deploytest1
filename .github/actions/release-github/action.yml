
# This action will create a Release to GitHub Releases from an existing build artifact

### NOTE: All bash scripts inlined here because external scripts dont appear to
###       be available at runtime when you manually check out an action repo and
###       then call the action using a local path location, such as when a public
###       repo needs to use an action stored in a private action repo with auth.
###       It seems that the local path action invocation wraps the action inside a
###       container without providing access to other scripts in the action repo.

name: 'jitx-python-github-release'
description: 'Release to GitHub Releases'
#inputs:
#  run-publish:
#    description: 'Whether to publish the results. (true/false)'
#    required: true
#    default: false

runs:
  using: "composite"
  steps:

    - name: Debug Dump GitHub context
      shell: bash
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"

    - name: Debug list artifact files
      shell: bash
      run: |
          ls -l pybuild-work/dist/*.whl || true
          ls -l pybuild-work/dist/version || true
          ls -l pybuild-work/dist/*.tar.gz || true

    - name: GitHub Release
      # only run if this is a tag event, the tag starts with 'v', and does not include '.dev'
      if: github.ref_type == 'tag' && startsWith(github.ref_name, 'v') && (! contains(github.ref_name, '.dev'))
      uses: softprops/action-gh-release@v2
      with:
        files: |
          pybuild-work/dist/*.whl
          pybuild-work/dist/*.tar.gz

    - name: Publish to Test PyPI
      # only run if this is a tag event, the tag starts with 'v', and does not include '.dev'
      if: github.ref_type == 'tag' && startsWith(github.ref_name, 'v') && (! contains(github.ref_name, '.dev'))
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        packages-dir: pybuild-work/dist/
